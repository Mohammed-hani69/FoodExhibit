{% extends "base.html" %}

{% block title %}معرض الأغذية - القاعات ثلاثية الأبعاد{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #ff6b00;
        --primary-dark: #e55f00;
        --text-primary: #1e3a5f;
        --text-secondary: #596475;
        --bg-light: #e8f1f5;
    }

    #gallery-3d {
        width: 100%;
        height: 600px;
        border-radius: 15px;
        overflow: hidden;
        position: relative;
    }

    @media (max-width: 768px) {
        #gallery-3d {
            height: 400px;
        }
    }

    @media (max-width: 576px) {
        #gallery-3d {
            height: 300px;
        }
    }
    
    .hall-selector {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 100;
    }

    @media (max-width: 576px) {
        .hall-selector {
            top: 10px;
            left: 10px;
        }

        .hall-selector .form-select {
            font-size: 0.9rem;
            padding: 0.375rem 0.5rem;
        }
    }
    
    .exhibitor-info {
        position: absolute;
        bottom: 20px;
        left: 20px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 15px;
        border-radius: 10px;
        max-width: 300px;
        display: none;
        z-index: 100;
    }

    @media (max-width: 768px) {
        .exhibitor-info {
            max-width: 250px;
            padding: 12px;
            font-size: 0.9rem;
        }
    }

    @media (max-width: 576px) {
        .exhibitor-info {
            max-width: 200px;
            padding: 10px;
            font-size: 0.8rem;
            bottom: 10px;
            left: 10px;
        }

        .exhibitor-info h5 {
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .exhibitor-info p {
            margin-bottom: 8px;
            font-size: 0.75rem;
        }

        .exhibitor-info .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
        }
    }
    
    .gallery-controls {
        position: absolute;
        bottom: 20px;
        right: 20px;
        z-index: 100;
    }
    
    .control-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        margin: 5px;
        background: rgba(255,255,255,0.9);
        border: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    @media (max-width: 576px) {
        .control-btn {
            width: 40px;
            height: 40px;
            margin: 3px;
            font-size: 0.9rem;
        }
    }
    
    .advertisement-wall {
        position: absolute;
        width: 200px;
        height: 150px;
        background: linear-gradient(45deg, var(--primary-color), var(--primary-dark));
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        z-index: 50;
        cursor: pointer;
        transition: transform 0.3s ease;
        perspective: 1000px;
    }
    
    .advertisement-wall:hover {
        transform: scale(1.05);
    }
    
    .wall-left {
        left: 10px;
        top: 200px;
    }
    
    .wall-right {
        right: 10px;
        top: 200px;
    }
    
    .wall-back {
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
    }

    /* Arrow Control Buttons Styling */
    .arrow-controls {
        position: absolute;
        bottom: 100px;
        right: 20px;
        display: grid;
        grid-template-columns: repeat(3, 50px);
        gap: 5px;
        z-index: 100;
    }

    @media (max-width: 576px) {
        .arrow-controls {
            bottom: 80px;
            right: 10px;
            grid-template-columns: repeat(3, 40px);
            gap: 3px;
        }
    }

    .arrow-btn {
        width: 50px;
        height: 50px;
        background: rgba(255, 165, 0, 0.85);
        border: 2px solid rgba(255, 100, 0, 0.9);
        border-radius: 8px;
        color: white;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        user-select: none;
    }

    @media (max-width: 576px) {
        .arrow-btn {
            width: 40px;
            height: 40px;
            font-size: 18px;
        }
    }

    .arrow-btn:hover {
        background: rgba(255, 140, 0, 0.9);
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    .arrow-btn:active {
        transform: scale(0.95);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .arrow-btn-empty {
        background: transparent;
        border: none;
    }

    .control-info {
        position: absolute;
        bottom: 220px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 12px;
        border-radius: 8px;
        font-size: 12px;
        z-index: 100;
        max-width: 200px;
        line-height: 1.5;
    }

    @media (max-width: 576px) {
        .control-info {
            bottom: 200px;
            right: 10px;
            font-size: 10px;
            padding: 8px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="text-white text-center mb-4">قاعات المعرض ثلاثية الأبعاد</h1>
            
            <!-- 3D Gallery Container -->
            <div id="gallery-3d" class="position-relative">
                <!-- Hall Selector -->
                <div class="hall-selector">
                    <select class="form-select" id="hallSelector" onchange="changeHall()">
                        <option value="hall1">القاعة الأولى</option>
                        <option value="hall2">القاعة الثانية</option>
                        <option value="hall3">القاعة الثالثة</option>
                    </select>
                </div>
                
                <!-- Gallery Controls -->
                <div class="gallery-controls">
                    <button class="control-btn" onclick="resetCamera()" title="إعادة تعيين الكاميرا">
                        <i class="fas fa-home"></i>
                    </button>
                    <button class="control-btn" onclick="toggleFullscreen()" title="ملء الشاشة">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button class="control-btn" onclick="toggleWireframe()" title="الإطار الشبكي">
                        <i class="fas fa-cube"></i>
                    </button>
                </div>
                
                <!-- Exhibitor Info Panel -->
                <div id="exhibitor-info" class="exhibitor-info">
                    <h5 id="exhibitor-name">اسم العارض</h5>
                    <p id="exhibitor-description">وصف العارض</p>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary btn-sm" onclick="visitExhibitor()">
                            زيارة العارض
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="toggleFavoriteExhibitor()">
                            <i class="fas fa-heart"></i>
                        </button>
                    </div>
                </div>

                <!-- Arrow Control Buttons -->
                <div class="control-info">
                    <strong>التحكم:</strong><br>
                    <span>↑↓←→ للحركة</span><br>
                    <span>Q/E للأعلى/الأسفل</span><br>
                    <span>Shift+أسهم للدوران</span>
                </div>

                <div class="arrow-controls">
                    <button class="arrow-btn arrow-btn-empty"></button>
                    <button class="arrow-btn" id="btnUp" title="للأمام (↑)">▲</button>
                    <button class="arrow-btn arrow-btn-empty"></button>
                    
                    <button class="arrow-btn" id="btnLeft" title="لليسار (←)">◄</button>
                    <button class="arrow-btn" id="btnDown" title="للخلف (↓)">▼</button>
                    <button class="arrow-btn" id="btnRight" title="لليمين (→)">►</button>

                    <button class="arrow-btn" id="btnUp2" title="للأعلى (Q)">⬆</button>
                    <button class="arrow-btn" id="btnDown2" title="للأسفل (E)">⬇</button>
                    <button class="arrow-btn arrow-btn-empty"></button>
                </div>
                
                <!-- 3D Advertisement Walls are now rendered in the Three.js scene -->
            </div>
            
            <!-- Gallery Info -->
            <div class="row mt-4">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">كيفية التنقل في المعرض</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <ul class="list-unstyled">
                                        <li><i class="fas fa-mouse me-2 text-primary"></i>انقر واسحب للنظر حولك</li>
                                        <li><i class="fas fa-scroll me-2 text-primary"></i>استخدم العجلة للتكبير والتصغير</li>
                                        <li><i class="fas fa-hand-pointer me-2 text-primary"></i>انقر على العارضين لعرض المعلومات</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <ul class="list-unstyled">
                                        <li><i class="fas fa-mouse me-2 text-success"></i>استخدم الماوس للدوران والحركة</li>
                                        <li><i class="fas fa-expand me-2 text-success"></i>استخدم وضع ملء الشاشة للتجربة الكاملة</li>
                                        <li><i class="fas fa-heart me-2 text-danger"></i>أضف العارضين المفضلين لصندوقك</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">إحصائيات المعرض</h5>
                            <ul class="list-unstyled">
                                {% for hall, exhibitors in exhibitors_by_hall.items() %}
                                <li class="d-flex justify-content-between">
                                    <span>{{ hall.replace('hall', 'القاعة ') }}</span>
                                    <span class="badge bg-primary">{{ exhibitors|length }} عارض</span>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
// OrbitControls from Three.js examples - embedded for compatibility
(function(){
    'use strict';
    THREE.OrbitControls = function ( object, domElement ) {
        this.object = object;
        this.domElement = ( domElement !== undefined ) ? domElement : document;
        this.enabled = true;
        this.target = new THREE.Vector3();
        this.enableZoom = true;
        this.zoomSpeed = 1.0;
        this.enableRotate = true;
        this.rotateSpeed = 1.0;
        this.enablePan = true;
        this.panSpeed = 1.0;
        this.enableDamping = false;
        this.dampingFactor = 0.25;
        this.minDistance = 0;
        this.maxDistance = Infinity;
        this.minZoom = 0;
        this.maxZoom = Infinity;
        this.minPolarAngle = 0;
        this.maxPolarAngle = Math.PI;
        this.minAzimuthAngle = - Infinity;
        this.maxAzimuthAngle = Infinity;
        
        var scope = this;
        var changeEvent = { type: 'change' };
        var startEvent = { type: 'start' };
        var endEvent = { type: 'end' };
        var STATE = { NONE: - 1, ROTATE: 0, DOLLY: 1, PAN: 2, TOUCH_ROTATE: 3, TOUCH_DOLLY_PAN: 4 };
        var state = STATE.NONE;
        var EPS = 0.000001;
        var spherical = new THREE.Spherical();
        var sphericalDelta = new THREE.Spherical();
        var scale = 1;
        var panOffset = new THREE.Vector3();
        var zoomChanged = false;
        var rotateStart = new THREE.Vector2();
        var rotateEnd = new THREE.Vector2();
        var rotateDelta = new THREE.Vector2();
        var panStart = new THREE.Vector2();
        var panEnd = new THREE.Vector2();
        var panDelta = new THREE.Vector2();
        var dollyStart = new THREE.Vector2();
        var dollyEnd = new THREE.Vector2();
        var dollyDelta = new THREE.Vector2();
        
        this.update = function () {
            var offset = new THREE.Vector3();
            var quat = new THREE.Quaternion().setFromUnitVectors( object.up, new THREE.Vector3( 0, 1, 0 ) );
            var quatInverse = quat.clone().inverse();
            var lastPosition = new THREE.Vector3();
            var lastQuaternion = new THREE.Quaternion();
            return function update() {
                var position = scope.object.position;
                offset.copy( position ).sub( scope.target );
                offset.applyQuaternion( quat );
                spherical.setFromVector3( offset );
                if ( scope.enableDamping ) {
                    spherical.theta += sphericalDelta.theta * scope.dampingFactor;
                    spherical.phi += sphericalDelta.phi * scope.dampingFactor;
                } else {
                    spherical.theta += sphericalDelta.theta;
                    spherical.phi += sphericalDelta.phi;
                }
                spherical.theta = Math.max( scope.minAzimuthAngle, Math.min( scope.maxAzimuthAngle, spherical.theta ) );
                spherical.phi = Math.max( scope.minPolarAngle, Math.min( scope.maxPolarAngle, spherical.phi ) );
                spherical.makeSafe();
                spherical.radius *= scale;
                spherical.radius = Math.max( scope.minDistance, Math.min( scope.maxDistance, spherical.radius ) );
                scope.target.add( panOffset );
                offset.setFromSpherical( spherical );
                offset.applyQuaternion( quatInverse );
                position.copy( scope.target ).add( offset );
                scope.object.lookAt( scope.target );
                if ( scope.enableDamping === true ) {
                    sphericalDelta.theta *= ( 1 - scope.dampingFactor );
                    sphericalDelta.phi *= ( 1 - scope.dampingFactor );
                } else {
                    sphericalDelta.set( 0, 0, 0 );
                }
                scale = 1;
                panOffset.set( 0, 0, 0 );
                if ( zoomChanged || lastPosition.distanceToSquared( scope.object.position ) > EPS || 8 * ( 1 - lastQuaternion.dot( scope.object.quaternion ) ) > EPS ) {
                    scope.dispatchEvent( changeEvent );
                    lastPosition.copy( scope.object.position );
                    lastQuaternion.copy( scope.object.quaternion );
                    zoomChanged = false;
                    return true;
                }
                return false;
            };
        }();
        
        this.reset = function () {
            state = STATE.NONE;
            scope.target.copy( scope.target0 );
            scope.object.position.copy( scope.position0 );
            scope.object.zoom = scope.zoom0;
            scope.object.updateProjectionMatrix();
            scope.dispatchEvent( changeEvent );
            scope.update();
        };
        
        // Event handlers for mouse/touch
        function onMouseDown( event ) {
            if ( scope.enabled === false ) return;
            event.preventDefault();
            switch ( event.button ) {
                case 0:
                    if ( scope.enableRotate === false ) return;
                    rotateStart.set( event.clientX, event.clientY );
                    state = STATE.ROTATE;
                    break;
                case 1:
                    if ( scope.enablePan === false ) return;
                    panStart.set( event.clientX, event.clientY );
                    state = STATE.PAN;
                    break;
                case 2:
                    if ( scope.enableZoom === false ) return;
                    dollyStart.set( event.clientX, event.clientY );
                    state = STATE.DOLLY;
                    break;
            }
            if ( state !== STATE.NONE ) {
                document.addEventListener( 'mousemove', onMouseMove, false );
                document.addEventListener( 'mouseup', onMouseUp, false );
                scope.dispatchEvent( startEvent );
            }
        }
        
        function onTouchStart( event ) {
            if ( scope.enabled === false ) return;
            
            switch ( event.touches.length ) {
                case 1:
                    rotateStart.set( event.touches[0].clientX, event.touches[0].clientY );
                    state = STATE.TOUCH_ROTATE;
                    break;
                case 2:
                    dollyStart.set( event.touches[0].clientX, event.touches[1].clientX );
                    state = STATE.TOUCH_DOLLY_PAN;
                    break;
            }
            
            if ( state !== STATE.NONE ) {
                scope.dispatchEvent( startEvent );
            }
        }
        
        function onTouchMove( event ) {
            if ( scope.enabled === false ) return;
            
            event.preventDefault();
            
            switch ( event.touches.length ) {
                case 1:
                    if ( state !== STATE.TOUCH_ROTATE ) return;
                    rotateEnd.set( event.touches[0].clientX, event.touches[0].clientY );
                    rotateDelta.subVectors( rotateEnd, rotateStart ).multiplyScalar( scope.rotateSpeed );
                    scope.rotateLeft( 2 * Math.PI * rotateDelta.x / scope.domElement.clientHeight );
                    scope.rotateUp( 2 * Math.PI * rotateDelta.y / scope.domElement.clientHeight );
                    rotateStart.copy( rotateEnd );
                    scope.update();
                    break;
                case 2:
                    if ( state !== STATE.TOUCH_DOLLY_PAN ) return;
                    dollyEnd.set( event.touches[0].clientX, event.touches[1].clientX );
                    dollyDelta.subVectors( dollyEnd, dollyStart );
                    if ( dollyDelta.x > 0 ) {
                        scope.dollyOut( scope.getZoomScale() );
                    } else if ( dollyDelta.x < 0 ) {
                        scope.dollyIn( scope.getZoomScale() );
                    }
                    dollyStart.copy( dollyEnd );
                    scope.update();
                    break;
            }
        }
        
        function onTouchEnd( event ) {
            if ( scope.enabled === false ) return;
            scope.dispatchEvent( endEvent );
            state = STATE.NONE;
        }
        
        function onMouseMove( event ) {
            if ( scope.enabled === false ) return;
            event.preventDefault();
            switch ( state ) {
                case STATE.ROTATE:
                    if ( scope.enableRotate === false ) return;
                    rotateEnd.set( event.clientX, event.clientY );
                    rotateDelta.subVectors( rotateEnd, rotateStart ).multiplyScalar( scope.rotateSpeed );
                    scope.rotateLeft( 2 * Math.PI * rotateDelta.x / scope.domElement.clientHeight );
                    scope.rotateUp( 2 * Math.PI * rotateDelta.y / scope.domElement.clientHeight );
                    rotateStart.copy( rotateEnd );
                    scope.update();
                    break;
                case STATE.DOLLY:
                    if ( scope.enableZoom === false ) return;
                    dollyEnd.set( event.clientX, event.clientY );
                    dollyDelta.subVectors( dollyEnd, dollyStart );
                    if ( dollyDelta.y > 0 ) {
                        scope.dollyIn( scope.getZoomScale() );
                    } else if ( dollyDelta.y < 0 ) {
                        scope.dollyOut( scope.getZoomScale() );
                    }
                    dollyStart.copy( dollyEnd );
                    scope.update();
                    break;
                case STATE.PAN:
                    if ( scope.enablePan === false ) return;
                    panEnd.set( event.clientX, event.clientY );
                    panDelta.subVectors( panEnd, panStart ).multiplyScalar( scope.panSpeed );
                    scope.pan( panDelta.x, panDelta.y );
                    panStart.copy( panEnd );
                    scope.update();
                    break;
            }
        }
        
        function onMouseUp( event ) {
            if ( scope.enabled === false ) return;
            document.removeEventListener( 'mousemove', onMouseMove, false );
            document.removeEventListener( 'mouseup', onMouseUp, false );
            scope.dispatchEvent( endEvent );
            state = STATE.NONE;
        }
        
        function onMouseWheel( event ) {
            if ( scope.enabled === false || scope.enableZoom === false || ( state !== STATE.NONE && state !== STATE.ROTATE ) ) return;
            event.preventDefault();
            event.stopPropagation();
            scope.dispatchEvent( startEvent );
            if ( event.deltaY < 0 ) {
                scope.dollyOut( scope.getZoomScale() );
            } else if ( event.deltaY > 0 ) {
                scope.dollyIn( scope.getZoomScale() );
            }
            scope.update();
            scope.dispatchEvent( endEvent );
        }
        
        this.rotateLeft = function ( angle ) {
            sphericalDelta.theta -= angle;
        };
        
        this.rotateUp = function ( angle ) {
            sphericalDelta.phi -= angle;
        };
        
        this.dollyIn = function ( dollyScale ) {
            scale /= dollyScale;
        };
        
        this.dollyOut = function ( dollyScale ) {
            scale *= dollyScale;
        };
        
        this.getZoomScale = function () {
            return Math.pow( 0.95, scope.zoomSpeed );
        };
        
        this.pan = function ( deltaX, deltaY ) {
            var element = scope.domElement === document ? scope.domElement.body : scope.domElement;
            var targetDistance = scope.object.position.distanceTo( scope.target );
            targetDistance *= Math.tan( ( scope.object.fov / 2 ) * Math.PI / 180.0 );
            scope.panLeft( 2 * deltaX * targetDistance / element.clientHeight, scope.object.matrix );
            scope.panUp( 2 * deltaY * targetDistance / element.clientHeight, scope.object.matrix );
        };
        
        this.panLeft = function ( distance, objectMatrix ) {
            var v = new THREE.Vector3();
            v.setFromMatrixColumn( objectMatrix, 0 );
            v.multiplyScalar( - distance );
            panOffset.add( v );
        };
        
        this.panUp = function ( distance, objectMatrix ) {
            var v = new THREE.Vector3();
            if ( scope.screenSpacePanning === true ) {
                v.setFromMatrixColumn( objectMatrix, 1 );
            } else {
                v.setFromMatrixColumn( objectMatrix, 0 );
                v.crossVectors( scope.object.up, v );
            }
            v.multiplyScalar( distance );
            panOffset.add( v );
        };
        
        this.dispose = function () {
            scope.domElement.removeEventListener( 'contextmenu', onContextMenu, false );
            scope.domElement.removeEventListener( 'mousedown', onMouseDown, false );
            scope.domElement.removeEventListener( 'wheel', onMouseWheel, false );
            scope.domElement.removeEventListener( 'touchstart', onTouchStart, false );
            scope.domElement.removeEventListener( 'touchmove', onTouchMove, false );
            scope.domElement.removeEventListener( 'touchend', onTouchEnd, false );
            document.removeEventListener( 'mousemove', onMouseMove, false );
            document.removeEventListener( 'mouseup', onMouseUp, false );
        };
        
        function onContextMenu( event ) {
            if ( scope.enabled === false ) return;
            event.preventDefault();
        }
        
        this.domElement.addEventListener( 'contextmenu', onContextMenu, false );
        this.domElement.addEventListener( 'mousedown', onMouseDown, false );
        this.domElement.addEventListener( 'wheel', onMouseWheel, false );
        this.domElement.addEventListener( 'touchstart', onTouchStart, false );
        this.domElement.addEventListener( 'touchmove', onTouchMove, false );
        this.domElement.addEventListener( 'touchend', onTouchEnd, false );
        
        this.target0 = this.target.clone();
        this.position0 = this.object.position.clone();
        this.zoom0 = this.object.zoom;
    };
    
    THREE.OrbitControls.prototype = Object.create( THREE.EventDispatcher.prototype );
    THREE.OrbitControls.prototype.constructor = THREE.OrbitControls;
})();
</script>

<script>
let scene, camera, renderer, controls;
let exhibitorObjects = [];
let selectedExhibitor = null;
let currentHall = 'hall1';

// Keyboard control variables
const keys = {};
const moveSpeed = 0.5;
const rotateSpeed = 0.05;

// Exhibitor data from backend
const exhibitorsData = {
    {% for hall, exhibitors in exhibitors_by_hall.items() %}
    "{{ hall }}": [
        {% for exhibitor in exhibitors %}
        {
            id: {{ exhibitor.id }},
            name: "{{ exhibitor.company_name }}",
            description: "{{ (exhibitor.description[:100] + '...') if exhibitor.description else 'No description available' }}",
            position: {
                x: {{ exhibitor.position_x }},
                y: {{ exhibitor.position_y }},
                z: {{ exhibitor.position_z }}
            },
            ranking: {{ exhibitor.ranking }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ]{% if not loop.last %},{% endif %}
    {% endfor %}
};

function initGallery() {
    // Scene setup
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87CEEB); // Sky blue
    
    // Camera setup
    const container = document.getElementById('gallery-3d');
    const width = container.offsetWidth;
    const height = container.offsetHeight;
    
    camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
    camera.position.set(0, 5, 15);
    
    // Renderer setup
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(width, height);
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    
    // Clear any existing renderer
    const existingCanvas = container.querySelector('canvas');
    if (existingCanvas) {
        existingCanvas.remove();
    }
    
    container.appendChild(renderer.domElement);
    
    // Controls - disabled to prevent mouse/scroll movement
    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = false;
    controls.enableRotate = false;  // Disable rotation with mouse
    controls.enableZoom = false;    // Disable zoom with scroll wheel
    controls.enablePan = false;     // Disable pan with mouse
    
    // Adjust controls for mobile devices
    if (window.innerWidth <= 768) {
        controls.rotateSpeed = 0.8;
        controls.zoomSpeed = 0.8;
        controls.panSpeed = 0.8;
    }
    
    // Lighting
    const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
    scene.add(ambientLight);
    
    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight.position.set(50, 50, 50);
    directionalLight.castShadow = true;
    scene.add(directionalLight);
    
    // Create gallery floor
    createGalleryFloor();
    
    // Create walls
    createGalleryWalls();
    
    // Load current hall
    loadHall(currentHall);
    
    // Animation loop
    animate();
    
    // Event listeners
    window.addEventListener('resize', onWindowResize, false);
    renderer.domElement.addEventListener('click', onMouseClick, false);
    
    // Keyboard event listeners for arrow controls
    document.addEventListener('keydown', onKeyDown, false);
    document.addEventListener('keyup', onKeyUp, false);
}

function createGalleryFloor() {
    // Create marble-like floor with texture pattern
    const floorGeometry = new THREE.PlaneGeometry(100, 100);
    
    // Create a canvas for custom floor texture
    const floorCanvas = document.createElement('canvas');
    floorCanvas.width = 512;
    floorCanvas.height = 512;
    const floorCtx = floorCanvas.getContext('2d');
    
    // Create marble pattern
    const gradient = floorCtx.createLinearGradient(0, 0, 512, 512);
    gradient.addColorStop(0, '#f5f5f5');
    gradient.addColorStop(0.5, '#e8e8e8');
    gradient.addColorStop(1, '#f0f0f0');
    floorCtx.fillStyle = gradient;
    floorCtx.fillRect(0, 0, 512, 512);
    
    // Add tile pattern
    floorCtx.strokeStyle = '#d0d0d0';
    floorCtx.lineWidth = 2;
    for (let i = 0; i < 512; i += 64) {
        floorCtx.beginPath();
        floorCtx.moveTo(i, 0);
        floorCtx.lineTo(i, 512);
        floorCtx.stroke();
        
        floorCtx.beginPath();
        floorCtx.moveTo(0, i);
        floorCtx.lineTo(512, i);
        floorCtx.stroke();
    }
    
    const floorTexture = new THREE.CanvasTexture(floorCanvas);
    floorTexture.wrapS = THREE.RepeatWrapping;
    floorTexture.wrapT = THREE.RepeatWrapping;
    floorTexture.repeat.set(8, 8);
    
    const floorMaterial = new THREE.MeshStandardMaterial({ 
        map: floorTexture,
        roughness: 0.4,
        metalness: 0.2
    });
    
    const floor = new THREE.Mesh(floorGeometry, floorMaterial);
    floor.rotation.x = -Math.PI / 2;
    floor.receiveShadow = true;
    scene.add(floor);
    
    // Add subtle grid for guidance
    const gridHelper = new THREE.GridHelper(100, 40, 0xe0e0e0, 0xf0f0f0);
    gridHelper.position.y = 0.01;
    gridHelper.material.opacity = 0.3;
    gridHelper.material.transparent = true;
    scene.add(gridHelper);
}

function createGalleryWalls() {
    // Create texture for walls with professional pattern
    function createWallTexture(color1, color2) {
        const canvas = document.createElement('canvas');
        canvas.width = 512;
        canvas.height = 512;
        const context = canvas.getContext('2d');
        
        // Create gradient background
        const gradient = context.createLinearGradient(0, 0, 512, 512);
        gradient.addColorStop(0, color1);
        gradient.addColorStop(0.5, color2);
        gradient.addColorStop(1, color1);
        context.fillStyle = gradient;
        context.fillRect(0, 0, 512, 512);
        
        // Add subtle pattern
        context.strokeStyle = 'rgba(255, 255, 255, 0.15)';
        context.lineWidth = 1;
        for (let i = 0; i < 512; i += 32) {
            context.beginPath();
            context.moveTo(i, 0);
            context.lineTo(i, 512);
            context.stroke();
            
            context.beginPath();
            context.moveTo(0, i);
            context.lineTo(512, i);
            context.stroke();
        }
        
        // Add vertical accent lines
        context.strokeStyle = 'rgba(255, 255, 255, 0.25)';
        context.lineWidth = 2;
        for (let i = 0; i < 512; i += 128) {
            context.beginPath();
            context.moveTo(i, 0);
            context.lineTo(i, 512);
            context.stroke();
        }
        
        return new THREE.CanvasTexture(canvas);
    }
    
    // Back wall - Professional white/blue gradient
    const backWallGeometry = new THREE.PlaneGeometry(100, 45);
    const backWallTexture = createWallTexture('#f5f5f5', '#e0e8f0');
    const backWallMaterial = new THREE.MeshStandardMaterial({ 
        map: backWallTexture,
        roughness: 0.6,
        metalness: 0.1,
        side: THREE.DoubleSide
    });
    const backWall = new THREE.Mesh(backWallGeometry, backWallMaterial);
    backWall.position.set(0, 22.5, -50);
    backWall.receiveShadow = true;
    backWall.castShadow = true;
    scene.add(backWall);
    
    // Add decorative frame to back wall
    const frameGeometry = new THREE.BufferGeometry();
    const frameVertices = new Float32Array([
        -50, 45, -49.9, 50, 45, -49.9,
        50, 45, -49.9, 50, 0, -49.9,
        50, 0, -49.9, -50, 0, -49.9,
        -50, 0, -49.9, -50, 45, -49.9
    ]);
    frameGeometry.setAttribute('position', new THREE.BufferAttribute(frameVertices, 3));
    const frameMaterial = new THREE.LineBasicMaterial({ color: 0xff6b00, linewidth: 3 });
    const frame = new THREE.LineSegments(frameGeometry, frameMaterial);
    scene.add(frame);
    
    // Left wall - Orange/gold gradient
    const leftWallGeometry = new THREE.PlaneGeometry(100, 45);
    const leftWallTexture = createWallTexture('#ff8c42', '#ffb366');
    const leftWallMaterial = new THREE.MeshStandardMaterial({ 
        map: leftWallTexture,
        roughness: 0.6,
        metalness: 0.1,
        side: THREE.DoubleSide
    });
    const leftWall = new THREE.Mesh(leftWallGeometry, leftWallMaterial);
    leftWall.rotation.y = Math.PI / 2;
    leftWall.position.set(-50, 22.5, 0);
    leftWall.receiveShadow = true;
    leftWall.castShadow = true;
    scene.add(leftWall);
    
    // Right wall - Blue/teal gradient
    const rightWallGeometry = new THREE.PlaneGeometry(100, 45);
    const rightWallTexture = createWallTexture('#4a90e2', '#5ba3f5');
    const rightWallMaterial = new THREE.MeshStandardMaterial({ 
        map: rightWallTexture,
        roughness: 0.6,
        metalness: 0.1,
        side: THREE.DoubleSide
    });
    const rightWall = new THREE.Mesh(rightWallGeometry, rightWallMaterial);
    rightWall.rotation.y = -Math.PI / 2;
    rightWall.position.set(50, 22.5, 0);
    rightWall.receiveShadow = true;
    rightWall.castShadow = true;
    scene.add(rightWall);
    
    // Add top accent wall
    const topWallGeometry = new THREE.PlaneGeometry(100, 10);
    const topWallTexture = createWallTexture('#2c3e50', '#34495e');
    const topWallMaterial = new THREE.MeshStandardMaterial({ 
        map: topWallTexture,
        roughness: 0.5,
        metalness: 0.2
    });
    const topWall = new THREE.Mesh(topWallGeometry, topWallMaterial);
    topWall.rotation.x = Math.PI / 2;
    topWall.position.set(0, 45, 0);
    topWall.receiveShadow = true;
    scene.add(topWall);
    
    // Add corner pillars for professional look
    function createPillar(x, z) {
        const pillarGeometry = new THREE.CylinderGeometry(2, 2.5, 45, 8);
        const pillarMaterial = new THREE.MeshStandardMaterial({ 
            color: 0xcccccc,
            roughness: 0.7,
            metalness: 0.1
        });
        const pillar = new THREE.Mesh(pillarGeometry, pillarMaterial);
        pillar.position.set(x, 22.5, z);
        pillar.castShadow = true;
        pillar.receiveShadow = true;
        scene.add(pillar);
    }
    
    createPillar(-48, -48);
    createPillar(48, -48);
    createPillar(-48, 48);
    createPillar(48, 48);
    
    // Create 3D Advertisement walls
    create3DAdvertisementWalls();
}

// Advertisement data from backend - fallback if no ads provided
const adsData = [
    {% for ad in ads %}
    {
        title: "{{ ad.title }}",
        description: "{{ ad.description|default('اضغط للمزيد') }}",
        link_url: "{{ ad.link_url }}",
        position: "{{ ad.position }}"
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

// If no ads from backend, create sample ads
if (adsData.length === 0) {
    adsData.push(
        { title: "إعلان ترحيبي", description: "مرحباً بكم في معرض الأغذية", link_url: "#", position: "back" },
        { title: "عروض خاصة", description: "احصل على خصومات حصرية", link_url: "#", position: "left" },
        { title: "منتجات جديدة", description: "اكتشف أحدث المنتجات", link_url: "#", position: "right" }
    );
}

let advertisementObjects = [];

function create3DAdvertisementWalls() {
    advertisementObjects.forEach(obj => scene.remove(obj));
    advertisementObjects = [];
    
    adsData.forEach(ad => {
        createAdvertisementPlane(ad);
    });
}

function createAdvertisementPlane(adData) {
    // Create canvas for advertisement texture
    const canvas = document.createElement('canvas');
    canvas.width = 512;
    canvas.height = 256;
    const context = canvas.getContext('2d');
    
    // Create gradient background
    const gradient = context.createLinearGradient(0, 0, 512, 256);
    gradient.addColorStop(0, '#667eea');
    gradient.addColorStop(1, '#764ba2');
    context.fillStyle = gradient;
    context.fillRect(0, 0, 512, 256);
    
    // Add border
    context.strokeStyle = '#ffffff';
    context.lineWidth = 4;
    context.strokeRect(0, 0, 512, 256);
    
    // Add title text
    context.fillStyle = '#ffffff';
    context.font = 'bold 32px Arial, sans-serif';
    context.textAlign = 'center';
    context.fillText(adData.title, 256, 80);
    
    // Add description text
    context.font = '20px Arial, sans-serif';
    context.fillText(adData.description, 256, 120);
    
    // Add call to action
    context.font = '16px Arial, sans-serif';
    context.fillText('اضغط للمزيد', 256, 180);
    
    // Add decorative elements
    context.beginPath();
    context.arc(50, 50, 20, 0, 2 * Math.PI);
    context.fillStyle = 'rgba(255, 255, 255, 0.3)';
    context.fill();
    
    context.beginPath();
    context.arc(462, 206, 15, 0, 2 * Math.PI);
    context.fill();
    
    // Create texture and material
    const texture = new THREE.CanvasTexture(canvas);
    const adGeometry = new THREE.PlaneGeometry(15, 7.5);
    const adMaterial = new THREE.MeshLambertMaterial({ 
        map: texture,
        transparent: true,
        side: THREE.DoubleSide
    });
    
    const advertisementPlane = new THREE.Mesh(adGeometry, adMaterial);
    
    // Position based on ad position
    switch (adData.position) {
        case 'back':
            advertisementPlane.position.set(0, 12, -49);
            break;
        case 'left':
            advertisementPlane.position.set(-49, 12, 0);
            advertisementPlane.rotation.y = Math.PI / 2;
            break;
        case 'right':
            advertisementPlane.position.set(49, 12, 0);
            advertisementPlane.rotation.y = -Math.PI / 2;
            break;
        default:
            // Default to back wall
            advertisementPlane.position.set(0, 12, -49);
    }
    
    // Store ad data for click interaction
    advertisementPlane.userData = adData;
    advertisementPlane.name = 'advertisement';
    
    // Add hover effect properties
    advertisementPlane.originalScale = advertisementPlane.scale.clone();
    
    scene.add(advertisementPlane);
    advertisementObjects.push(advertisementPlane);
}

function loadHall(hallName) {
    // Clear existing exhibitors
    exhibitorObjects.forEach(obj => scene.remove(obj));
    exhibitorObjects = [];
    
    // Load exhibitors for this hall
    const exhibitors = exhibitorsData[hallName] || [];
    
    exhibitors.forEach((exhibitor, index) => {
        createExhibitorStand(exhibitor, index);
    });
}

function createExhibitorStand(exhibitor, index) {
    // Create exhibitor stand
    const standGroup = new THREE.Group();
    
    // Base platform
    const baseGeometry = new THREE.CylinderGeometry(3, 3, 0.5, 8);
    const baseMaterial = new THREE.MeshLambertMaterial({ 
        color: 0x8B4513 // Brown
    });
    const base = new THREE.Mesh(baseGeometry, baseMaterial);
    base.castShadow = true;
    standGroup.add(base);
    
    // Exhibitor booth
    const boothGeometry = new THREE.BoxGeometry(4, 4, 2);
    const boothMaterial = new THREE.MeshLambertMaterial({ 
        color: `hsl(${(exhibitor.ranking * 137.5) % 360}, 70%, 60%)`
    });
    const booth = new THREE.Mesh(boothGeometry, boothMaterial);
    booth.position.y = 2.5;
    booth.castShadow = true;
    standGroup.add(booth);
    
    // Name plate with text
    const nameCanvas = document.createElement('canvas');
    nameCanvas.width = 512;
    nameCanvas.height = 128;
    const nameContext = nameCanvas.getContext('2d');
    nameContext.fillStyle = '#ffffff';
    nameContext.fillRect(0, 0, 512, 128);
    nameContext.fillStyle = '#000000';
    nameContext.font = 'bold 32px Arial';
    nameContext.textAlign = 'center';
    nameContext.fillText(exhibitor.name, 256, 80);
    
    const nameTexture = new THREE.CanvasTexture(nameCanvas);
    const nameGeometry = new THREE.PlaneGeometry(3, 0.75);
    const nameMaterial = new THREE.MeshLambertMaterial({ map: nameTexture });
    const nameplate = new THREE.Mesh(nameGeometry, nameMaterial);
    nameplate.position.set(0, 1, 2.1);
    standGroup.add(nameplate);
    
    // Position the stand
    const angle = (index / exhibitorsData[currentHall].length) * Math.PI * 2;
    const radius = Math.max(8, 20 - (exhibitor.ranking * 1.5)); // Prevent negative radius, closer to center = higher ranking
    
    standGroup.position.x = Math.cos(angle) * radius;
    standGroup.position.z = Math.sin(angle) * radius;
    standGroup.position.y = 0.25;
    
    // Store exhibitor data
    standGroup.userData = exhibitor;
    
    scene.add(standGroup);
    exhibitorObjects.push(standGroup);
}

// Keyboard control functions
function onKeyDown(event) {
    keys[event.key] = true;
}

function onKeyUp(event) {
    keys[event.key] = false;
}

function handleKeyboardMovement() {
    // Handle arrow key movements
    if (keys['ArrowUp'] || keys['w'] || keys['W']) {
        // Move forward
        const moveDir = new THREE.Vector3();
        camera.getWorldDirection(moveDir);
        moveDir.y = 0; // Keep horizontal movement
        moveDir.normalize();
        camera.position.addScaledVector(moveDir, moveSpeed);
    }
    
    if (keys['ArrowDown'] || keys['s'] || keys['S']) {
        // Move backward
        const moveDir = new THREE.Vector3();
        camera.getWorldDirection(moveDir);
        moveDir.y = 0;
        moveDir.normalize();
        camera.position.addScaledVector(moveDir, -moveSpeed);
    }
    
    if (keys['ArrowLeft'] || keys['a'] || keys['A']) {
        // Move left
        const moveDir = new THREE.Vector3();
        camera.getWorldDirection(moveDir);
        moveDir.y = 0;
        moveDir.normalize();
        const leftDir = new THREE.Vector3();
        leftDir.crossVectors(camera.up, moveDir);
        camera.position.addScaledVector(leftDir, moveSpeed);
    }
    
    if (keys['ArrowRight'] || keys['d'] || keys['D']) {
        // Move right
        const moveDir = new THREE.Vector3();
        camera.getWorldDirection(moveDir);
        moveDir.y = 0;
        moveDir.normalize();
        const rightDir = new THREE.Vector3();
        rightDir.crossVectors(camera.up, moveDir);
        camera.position.addScaledVector(rightDir, -moveSpeed);
    }
    
    // Vertical movement (Q and E keys)
    if (keys['q'] || keys['Q']) {
        camera.position.y += moveSpeed;
    }
    
    if (keys['e'] || keys['E']) {
        camera.position.y -= moveSpeed;
    }
    
    // Camera rotation with arrow keys + Shift
    if (keys['Shift']) {
        if (keys['ArrowUp']) {
            camera.rotateOnWorldAxis(new THREE.Vector3(1, 0, 0), rotateSpeed);
        }
        if (keys['ArrowDown']) {
            camera.rotateOnWorldAxis(new THREE.Vector3(1, 0, 0), -rotateSpeed);
        }
        if (keys['ArrowLeft']) {
            camera.rotateOnWorldAxis(new THREE.Vector3(0, 1, 0), rotateSpeed);
        }
        if (keys['ArrowRight']) {
            camera.rotateOnWorldAxis(new THREE.Vector3(0, 1, 0), -rotateSpeed);
        }
    }
}

function onMouseClick(event) {
    const mouse = new THREE.Vector2();
    const rect = renderer.domElement.getBoundingClientRect();
    
    mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
    mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
    
    const raycaster = new THREE.Raycaster();
    raycaster.setFromCamera(mouse, camera);
    
    // Check for advertisement clicks first
    const adIntersects = raycaster.intersectObjects(advertisementObjects, false);
    if (adIntersects.length > 0) {
        const clickedAd = adIntersects[0].object;
        if (clickedAd.userData && clickedAd.userData.link_url) {
            // Add click animation
            clickedAd.scale.set(1.1, 1.1, 1.1);
            setTimeout(() => {
                clickedAd.scale.copy(clickedAd.originalScale);
            }, 200);
            
            // Open advertisement link
            if (clickedAd.userData.link_url !== '#') {
                window.open(clickedAd.userData.link_url, '_blank');
            } else {
                alert(`إعلان: ${clickedAd.userData.title}\n${clickedAd.userData.description}`);
            }
        }
        return;
    }
    
    // Check for exhibitor clicks
    const exhibitorIntersects = raycaster.intersectObjects(exhibitorObjects, true);
    if (exhibitorIntersects.length > 0) {
        const clickedExhibitor = exhibitorIntersects[0].object.parent;
        if (clickedExhibitor.userData) {
            showExhibitorInfo(clickedExhibitor.userData);
            selectedExhibitor = clickedExhibitor.userData;
        }
    } else {
        hideExhibitorInfo();
        selectedExhibitor = null;
    }
}

function showExhibitorInfo(exhibitor) {
    document.getElementById('exhibitor-name').textContent = exhibitor.name;
    document.getElementById('exhibitor-description').textContent = exhibitor.description;
    document.getElementById('exhibitor-info').style.display = 'block';
}

function hideExhibitorInfo() {
    document.getElementById('exhibitor-info').style.display = 'none';
}

function visitExhibitor() {
    if (selectedExhibitor) {
        window.location.href = `/exhibitor/${selectedExhibitor.id}`;
    }
}

function toggleFavoriteExhibitor() {
    if (selectedExhibitor) {
        fetch(`/toggle-favorite-exhibitor/${selectedExhibitor.id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(data.action === 'added' ? 'تم إضافة العارض للمفضلة' : 'تم إزالة العارض من المفضلة');
            }
        });
    }
}

function changeHall() {
    const hallSelector = document.getElementById('hallSelector');
    currentHall = hallSelector.value;
    loadHall(currentHall);
}

function resetCamera() {
    camera.position.set(0, 5, 15);
    controls.reset();
}

function toggleFullscreen() {
    const galleryContainer = document.getElementById('gallery-3d');
    if (document.fullscreenElement) {
        document.exitFullscreen();
    } else {
        galleryContainer.requestFullscreen();
    }
}

function toggleWireframe() {
    exhibitorObjects.forEach(obj => {
        obj.children.forEach(child => {
            if (child.material) {
                child.material.wireframe = !child.material.wireframe;
            }
        });
    });
}

function openAdLink(url) {
    if (url) {
        window.open(url, '_blank');
    }
}

function onWindowResize() {
    const container = document.getElementById('gallery-3d');
    const width = container.offsetWidth;
    const height = container.offsetHeight;
    
    if (width === 0 || height === 0) return;
    
    camera.aspect = width / height;
    camera.updateProjectionMatrix();
    renderer.setSize(width, height);
}

function animate() {
    requestAnimationFrame(animate);
    handleKeyboardMovement();
    controls.update();
    renderer.render(scene, camera);
}

// Initialize gallery when page loads
document.addEventListener('DOMContentLoaded', initGallery);

// Setup arrow button click handlers
document.addEventListener('DOMContentLoaded', function() {
    const btnUp = document.getElementById('btnUp');
    const btnDown = document.getElementById('btnDown');
    const btnLeft = document.getElementById('btnLeft');
    const btnRight = document.getElementById('btnRight');
    const btnUp2 = document.getElementById('btnUp2');
    const btnDown2 = document.getElementById('btnDown2');
    
    // Helper function to simulate key press
    function simulateKeyDown(key) {
        keys[key] = true;
    }
    
    function simulateKeyUp(key) {
        keys[key] = false;
    }
    
    // Up button
    btnUp.addEventListener('mousedown', function() {
        simulateKeyDown('ArrowUp');
    });
    btnUp.addEventListener('mouseup', function() {
        simulateKeyUp('ArrowUp');
    });
    btnUp.addEventListener('mouseleave', function() {
        simulateKeyUp('ArrowUp');
    });
    btnUp.addEventListener('touchstart', function(e) {
        e.preventDefault();
        simulateKeyDown('ArrowUp');
    });
    btnUp.addEventListener('touchend', function(e) {
        e.preventDefault();
        simulateKeyUp('ArrowUp');
    });
    
    // Down button
    btnDown.addEventListener('mousedown', function() {
        simulateKeyDown('ArrowDown');
    });
    btnDown.addEventListener('mouseup', function() {
        simulateKeyUp('ArrowDown');
    });
    btnDown.addEventListener('mouseleave', function() {
        simulateKeyUp('ArrowDown');
    });
    btnDown.addEventListener('touchstart', function(e) {
        e.preventDefault();
        simulateKeyDown('ArrowDown');
    });
    btnDown.addEventListener('touchend', function(e) {
        e.preventDefault();
        simulateKeyUp('ArrowDown');
    });
    
    // Left button
    btnLeft.addEventListener('mousedown', function() {
        simulateKeyDown('ArrowLeft');
    });
    btnLeft.addEventListener('mouseup', function() {
        simulateKeyUp('ArrowLeft');
    });
    btnLeft.addEventListener('mouseleave', function() {
        simulateKeyUp('ArrowLeft');
    });
    btnLeft.addEventListener('touchstart', function(e) {
        e.preventDefault();
        simulateKeyDown('ArrowLeft');
    });
    btnLeft.addEventListener('touchend', function(e) {
        e.preventDefault();
        simulateKeyUp('ArrowLeft');
    });
    
    // Right button
    btnRight.addEventListener('mousedown', function() {
        simulateKeyDown('ArrowRight');
    });
    btnRight.addEventListener('mouseup', function() {
        simulateKeyUp('ArrowRight');
    });
    btnRight.addEventListener('mouseleave', function() {
        simulateKeyUp('ArrowRight');
    });
    btnRight.addEventListener('touchstart', function(e) {
        e.preventDefault();
        simulateKeyDown('ArrowRight');
    });
    btnRight.addEventListener('touchend', function(e) {
        e.preventDefault();
        simulateKeyUp('ArrowRight');
    });
    
    // Up movement (Q key)
    btnUp2.addEventListener('mousedown', function() {
        simulateKeyDown('q');
    });
    btnUp2.addEventListener('mouseup', function() {
        simulateKeyUp('q');
    });
    btnUp2.addEventListener('mouseleave', function() {
        simulateKeyUp('q');
    });
    btnUp2.addEventListener('touchstart', function(e) {
        e.preventDefault();
        simulateKeyDown('q');
    });
    btnUp2.addEventListener('touchend', function(e) {
        e.preventDefault();
        simulateKeyUp('q');
    });
    
    // Down movement (E key)
    btnDown2.addEventListener('mousedown', function() {
        simulateKeyDown('e');
    });
    btnDown2.addEventListener('mouseup', function() {
        simulateKeyUp('e');
    });
    btnDown2.addEventListener('mouseleave', function() {
        simulateKeyUp('e');
    });
    btnDown2.addEventListener('touchstart', function(e) {
        e.preventDefault();
        simulateKeyDown('e');
    });
    btnDown2.addEventListener('touchend', function(e) {
        e.preventDefault();
        simulateKeyUp('e');
    });
});
</script>
{% endblock %}