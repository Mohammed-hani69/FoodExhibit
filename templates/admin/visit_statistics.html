{% extends "base.html" %}

{% block title %}
    {% if current_language == 'en' %}
        Visit Statistics - Food Exhibition
    {% elif current_language == 'ar' %}
        إحصائيات الزيارات - معرض الأغذية
    {% endif %}
{% endblock %}

{% block extra_css %}
<style>
    .analytics-dashboard {
        padding: 2rem;
        background: #fff;
        border-radius: 15px;
        box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }

    .chart-container {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        border: 1px solid #e0e0e0;
    }

    .stats-card {
        background: linear-gradient(135deg, #95c11f 0%, #7da019 100%);
        color: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        transition: transform 0.3s ease;
    }

    .stats-card:hover {
        transform: translateY(-5px);
    }

    .stats-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }

    .stats-label {
        font-size: 1rem;
        opacity: 0.9;
    }

    .heatmap-container {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        height: 400px;
    }

    .filter-section {
        margin-bottom: 2rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 10px;
    }
</style>
<!-- Chart.js and heatmap.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/heatmap.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid analytics-dashboard">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="text-center mb-4">
                {% if current_language == 'en' %}
                    Visit Statistics Dashboard
                {% elif current_language == 'ar' %}
                    لوحة إحصائيات الزيارات
                {% endif %}
            </h2>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
        <div class="row">
            <div class="col-md-3">
                <select class="form-select" id="timeRange">
                    <option value="7">Last 7 days</option>
                    <option value="30">Last 30 days</option>
                    <option value="90">Last 90 days</option>
                    <option value="365">Last year</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="visitorType">
                    <option value="all">All Visitors</option>
                    <option value="new">New Visitors</option>
                    <option value="returning">Returning Visitors</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number">{{ total_visits }}</div>
                <div class="stats-label">Total Visits</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number">{{ unique_visitors }}</div>
                <div class="stats-label">Unique Visitors</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number">{{ avg_duration }}</div>
                <div class="stats-label">Average Visit Duration</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number">{{ bounce_rate }}%</div>
                <div class="stats-label">Bounce Rate</div>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="chart-container">
                <canvas id="visitorTrendChart"></canvas>
            </div>
        </div>
        <div class="col-md-4">
            <div class="chart-container">
                <canvas id="visitorTypeChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Visitor Heatmap -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="heatmap-container" id="visitorHeatmap"></div>
        </div>
    </div>

    <!-- Popular Times Table -->
    <div class="row">
        <div class="col-12">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Visitors</th>
                            <th>Average Duration</th>
                            <th>Popular Sections</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for time in popular_times %}
                        <tr>
                            <td>{{ time.hour }}</td>
                            <td>{{ time.visitors }}</td>
                            <td>{{ time.avg_duration }}</td>
                            <td>{{ time.popular_sections }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
// Visitor Trend Chart
const visitorTrendCtx = document.getElementById('visitorTrendChart').getContext('2d');
new Chart(visitorTrendCtx, {
    type: 'line',
    data: {
        labels: {{ dates|safe }},
        datasets: [{
            label: 'Visitors',
            data: {{ visitor_data|safe }},
            borderColor: '#95c11f',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        plugins: {
            title: {
                display: true,
                text: 'Visitor Trend'
            }
        }
    }
});

// Visitor Type Distribution Chart
const visitorTypeCtx = document.getElementById('visitorTypeChart').getContext('2d');
new Chart(visitorTypeCtx, {
    type: 'doughnut',
    data: {
        labels: ['New', 'Returning'],
        datasets: [{
            data: {{ visitor_type_distribution|safe }},
            backgroundColor: ['#95c11f', '#7da019']
        }]
    },
    options: {
        responsive: true,
        plugins: {
            title: {
                display: true,
                text: 'Visitor Type Distribution'
            }
        }
    }
});

// Visitor Heatmap
const heatmapInstance = h337.create({
    container: document.getElementById('visitorHeatmap'),
    radius: 30,
    maxOpacity: 0.6,
    minOpacity: 0,
    blur: .75
});

// Sample heatmap data (replace with actual data)
const heatmapData = {
    max: 100,
    data: {{ heatmap_data|safe }}
};

heatmapInstance.setData(heatmapData);

// Event listeners for filters
document.getElementById('timeRange').addEventListener('change', updateCharts);
document.getElementById('visitorType').addEventListener('change', updateCharts);

function updateCharts() {
    const timeRange = document.getElementById('timeRange').value;
    const visitorType = document.getElementById('visitorType').value;
    
    fetch(`/admin/visitor-data?timeRange=${timeRange}&visitorType=${visitorType}`)
        .then(response => response.json())
        .then(data => {
            // Update charts with new data
            updateVisitorTrendChart(data.visitorTrend);
            updateVisitorTypeChart(data.visitorType);
            updateHeatmap(data.heatmapData);
        });
}
</script>
{% endblock %}
